pipeline {
    agent any

    environment {
        IMAGE_NAME = 'asia-southeast1-docker.pkg.dev/devops-415704/docker-privatehub/vaniheroesweb:latest'
        // Corrected Artifact Registry URL and image name
    }

    stages {
        stage('Build Docker Image') {
            steps {
                script {
                    docker.build("${IMAGE_NAME}")
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                script {
                    // Using the GCP JSON key as a secret text
                    withCredentials([string(credentialsId: 'gcp-jenkins-access', variable: 'GCP_JSON')]) {
                        sh '''
                            echo $GCP_JSON > gcp-jenkins-access.json
                            gcloud auth activate-service-account --key-file=gcp-jenkins-access.json
                            // Your commands here
                            rm -f gcp-key.json
                        '''

                    }
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    def servers = ['34.142.163.44']
                    for (def server : servers) {
                        echo "Deploying to ${server}"
                        sshagent(['server-ssh-key']) {
                            sh """
                                ssh user@${server} '
                                    docker pull ${IMAGE_NAME} && 
                                    docker stop vaniheroes-website || true && 
                                    docker rm vaniheroes-website || true && 
                                    docker run -d --name vaniheroes-website -p 80:80 ${IMAGE_NAME}
                                '
                            """
                        }
                        sleep(30) // Delay for verification or health checks
                    }
                }
            }
        }
    }
}
