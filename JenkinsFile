pipeline {
    agent any

    environment {
        IMAGE_NAME = 'asia-southeast1-docker.pkg.dev/devops-415704/docker-privatehub/vaniheroesweb:latest'
        // Corrected Artifact Registry URL and image name
    }

    stages {
        stage('Build Docker Image') {
            steps {
                script {
                    docker.build("${IMAGE_NAME}")
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                script {
                    // Use the secret text directly
            withCredentials([string(credentialsId: 'jenkins-gcp', variable: 'GCP_JSON_KEY')]) {
                // Temporarily write the GCP JSON key to a file for authentication
                sh "echo '$GCP_JSON_KEY' > jenkins-gcp"
                sh 'gcloud auth activate-service-account --key-file=jenkins-gcp'
                sh 'gcloud auth configure-docker asia-southeast1-docker.pkg.dev --quiet'
                // Now you can push the image
                sh "docker push ${IMAGE_NAME}"
                // Clean up the temporary file
                sh 'rm -f jenkins-gcp'
                    }
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    def servers = ['34.142.163.44']
                    for (def server : servers) {
                        echo "Deploying to ${server}"
                        sshagent(['server-ssh-key']) {
                            sh """
                                ssh user@${server} '
                                    docker pull ${IMAGE_NAME} && 
                                    docker stop vaniheroes-website || true && 
                                    docker rm vaniheroes-website || true && 
                                    docker run -d --name vaniheroes-website -p 80:80 ${IMAGE_NAME}
                                '
                            """
                        }
                        sleep(30) // Delay for verification or health checks
                    }
                }
            }
        }
    }
}
